name: Release

on:
  push:
    branches:
      - 'v*'
    tags:
      - 'v*'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs: 
      version: ${{ steps.tag-version.outputs.version }}
    steps:
      - name: label version
        id: tag-version
        run: echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT

  publish:
    needs: 
      - version
    strategy:
      matrix:
        platform: [chrome, edge, firefox, github]
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        name: Use Node.js
        with:
          node-version: 18.x
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - run: npm install --save

      - run: npm run build
        env:
          VERSION: ${{ needs.version.outputs.version }}

      - name: Release
        if: matrix.platform == 'github'
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}

      - name: Firefox Upload & release
        run: npx web-ext sign -s build/firefox
        if: matrix.platform == 'firefox'
        env:
          WEB_EXT_API_KEY: ${{ secrets.FIREFOX_WEB_EXT_API_KEY }}
          WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_WEB_EXT_API_SECRET }}
      
      - name: Chrome Upload & release
        if: matrix.platform == 'chrome'
        uses: mnao305/chrome-extension-upload@v4.0.1
        with:
          file-path: build/chrome-${{ needs.version.outputs.version }}.zip
          extension-id: 'hihgfcgbmnbomabfdbajlbpnacndeihl'
          client-id: ${{ secrets.GOOGLE_CLIENT_ID }}
          client-secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          refresh-token: ${{ secrets.GOOGLE_REFRESH_TOKEN }}

      - name: Edge Upload & release
        run: node pipeline/edge-addon-publish.mjs
        if: matrix.platform == 'edge'
        env:
          VERSION: ${{ needs.version.outputs.version }}
          EDGE_CLIENT_ID: ${{ secrets.EDGE_CLIENT_ID }}
          EDGE_CLIENT_SECRET: ${{ secrets.EDGE_CLIENT_SECRET }}
          EDGE_ACCESS_TOKEN_URL: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
          EDGE_PRODUCT_ID: ${{ secrets.EDGE_PRODUCT_ID }}